FROM node:20-bullseye

WORKDIR /app

# Dependências do sistema (OpenSSL 1.1 presente no bullseye)
RUN apt-get update -y && apt-get install -y openssl ca-certificates && rm -rf /var/lib/apt/lists/*

# Config de retries do npm para evitar falhas transitórias
RUN npm config set fetch-retries 5 \
  && npm config set fetch-retry-factor 2 \
  && npm config set fetch-retry-maxtimeout 60000 \
  && npm config set fetch-retry-mintimeout 10000

# Copiar manifests
COPY package.json package-lock.json* ./

# Instalar dependências (scripts habilitados para baixar engines)
RUN npm ci

# Copiar restante
COPY tsconfig.json tsconfig.build.json nest-cli.json ./
COPY prisma ./prisma
COPY src ./src
COPY docker/entrypoint.sh ./docker/entrypoint.sh

# Gerar Prisma Client (vai baixar engines; cache em layer)
RUN npx prisma generate

# Tornar entrypoint executável
RUN chmod +x docker/entrypoint.sh

ENV NODE_ENV=development
EXPOSE 3000

ENTRYPOINT ["sh","./docker/entrypoint.sh"]